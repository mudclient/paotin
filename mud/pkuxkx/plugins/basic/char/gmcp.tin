#nop vim: set filetype=tt:;

/*
æœ¬æ–‡ä»¶å±äº PaoTin++ çš„ä¸€éƒ¨åˆ†
===========
PaoTin++ Â© 2020~2023 çš„æ‰€æœ‰ç‰ˆæƒå‡ç”±æ‹…å­ç‚®(dzp <danzipao@gmail.com>) äº«æœ‰å¹¶ä¿ç•™ä¸€åˆ‡æ³•å¾‹æƒåˆ©
ä½ å¯ä»¥åœ¨éµç…§ GPLv3 åè®®çš„åŸºç¡€ä¹‹ä¸Šä½¿ç”¨ã€ä¿®æ”¹åŠé‡æ–°åˆ†å‘æœ¬ç¨‹åºã€‚
===========
*/

#var basic_char_gmcp[META] {
    {NAME}      {GMCPè§’è‰²ä¿¡æ¯}
    {DESC}      {è§£æ GMCP.Status äº‹ä»¶æä¾›çš„è§’è‰²ä¿¡æ¯}
    {AUTHOR}    {æ‹…å­ç‚®}
    {NOTE}      {æœ¬æ–‡ä»¶å±äº PaoTin++ çš„ä¸€éƒ¨åˆ†}
};

load-lib event;
load-lib speedo;

event.Define {char/busy}    {æ— å‚} {$MODULE} {è§’è‰²è¢« busy äº†};
event.Define {char/nobusy}  {æ— å‚} {$MODULE} {è§’è‰²è§£é™¤ busy äº†};
event.Define {char/fight}   {æ— å‚} {$MODULE} {è§’è‰²æˆ˜æ–—å¼€å§‹};
event.Define {char/nofight} {æ— å‚} {$MODULE} {è§’è‰²è„±ç¦»æˆ˜æ–—};

#func {basic_char_gmcp.Init} {
    event.Handle {GMCP.Status} {char/gmcp} {basic/char/gmcp} {char.gmcp.status};
};

#var {gmcp-name-map} {
    {HP} {
        {ç»éªŒ}          {ç»éªŒ}          {combat_exp}        {ç»éªŒ}
        {æ½œèƒ½}          {æ½œèƒ½}          {potential}         {æ½œèƒ½}
        {æœ€å¤§å†…åŠ›}      {æœ€å¤§å†…åŠ›}      {max_neili}         {æœ€å¤§å†…åŠ›}
        {å†…åŠ›}          {å½“å‰å†…åŠ›}      {neili}             {å½“å‰å†…åŠ›}
        {æœ€å¤§ç²¾åŠ›}      {æœ€å¤§ç²¾åŠ›}      {max_jingli}        {æœ€å¤§ç²¾åŠ›}
        {ç²¾åŠ›}          {å½“å‰ç²¾åŠ›}      {jingli}            {å½“å‰ç²¾åŠ›}
        {æœ€å¤§æ°”è¡€}      {æœ€å¤§æ°”è¡€}      {max_qi}            {æœ€å¤§æ°”è¡€}
        {æœ‰æ•ˆæ°”è¡€}      {æœ‰æ•ˆæ°”è¡€}      {eff_qi}            {æœ‰æ•ˆæ°”è¡€}
        {æ°”è¡€}          {å½“å‰æ°”è¡€}      {qi}                {å½“å‰æ°”è¡€}
        {æœ€å¤§ç²¾ç¥}      {æœ€å¤§ç²¾ç¥}      {max_jing}          {æœ€å¤§ç²¾ç¥}
        {æœ‰æ•ˆç²¾ç¥}      {æœ‰æ•ˆç²¾ç¥}      {eff_jing}          {æœ‰æ•ˆç²¾ç¥}
        {ç²¾ç¥}          {å½“å‰ç²¾ç¥}      {jing}              {å½“å‰ç²¾ç¥}
        {çœŸæ°”}          {å½“å‰çœŸæ°”}      {vigour/qi}         {å½“å‰çœŸæ°”}
        {çœŸå…ƒ}          {çœŸå…ƒ}          {vigour/yuan}       {çœŸå…ƒ}
        {é£Ÿç‰©}          {é£Ÿç‰©}          {food}              {é£Ÿç‰©}
        {é¥®æ°´}          {é¥®æ°´}          {water}             {é¥®æ°´}
        {å¿™}            {å¿™}            {is_busy}           {å¿™}
        {æˆ˜æ„}          {æˆ˜æ„}          {fighter_spirit}    {æˆ˜æ„}
        {æˆ˜æ–—ä¸­}        {æˆ˜æ–—ä¸­}        {is_fighting}       {æˆ˜æ–—ä¸­}
    }

    {æ¡£æ¡ˆ} {
        {å¤´è¡”}      {å¤´è¡”}              {title}                 {å¤´è¡”}
        {é—¨æ´¾}      {é—¨æ´¾}              {family/family_name}    {é—¨æ´¾}
        {çº§åˆ«}      {äººç‰©ç­‰çº§}          {level}                 {äººç‰©ç­‰çº§}
        {ï¼©ï¼¤}      {è´¦å·}              {id}                    {è´¦å·}
        {å§“å}      {å¤§å}              {name}                  {å¤§å}
    }

    {å¤©èµ‹} {
        {å®¹è²Œ}      {å®¹è²Œ}              {per}                   {å®¹è²Œ}
        {è†‚åŠ›}      {è†‚åŠ›}              {str}                   {è†‚åŠ›}
        {æ‚Ÿæ€§}      {æ‚Ÿæ€§}              {int}                   {æ‚Ÿæ€§}
        {æ ¹éª¨}      {æ ¹éª¨}              {con}                   {æ ¹éª¨}
        {èº«æ³•}      {èº«æ³•}              {dex}                   {èº«æ³•}
    }
};

#alias {char.gmcp.status} {
    #local busy     {};
    #local fight    {};
    #local hasHP    {0};
    #local hasScore {0};

    #local id {$gGMCP[Status][id]};
    #if { "$id" == "" } {
        #local id {$gGMCP[Status][ï¼©ï¼¤]};
    };

    #nop ID ä¸­åŒ…å« # å·çš„ï¼Œæ˜¯ NPCï¼Œæ²¡æœ‰ # å·ä½†å’Œè‡ªå·± ID ä¸åŒçš„ï¼Œæ˜¯ç©å®¶ã€‚;
    #nop æ²¡æœ‰ ID æˆ–è€… ID å’Œè‡ªå·±ç›¸åŒçš„ï¼Œæ‰æ˜¯è‡ªå·±çš„æ•°æ®ã€‚;
    #if { "$id" != "" && "$id" != "$user[id]" } {
        #return;
    };

    #local key      {};
    #foreach {*gGMCP[Status][]} {key} {
        #local value {$gGMCP[Status][$key]};

        #local name {$gmcp-name-map[HP][$key]};
        #if { "$name" != "" } {
            #local hasHP {1};

            #if { "$name" == "{å½“å‰.*|ç»éªŒ|æ½œèƒ½|é£Ÿç‰©|é¥®æ°´}" } {
                speedo.Set {$name} {$value} {true} {10};
            };

            #if { "$name" == "å½“å‰%*" } {
                #local bakName {$name};
                #replace bakName {å½“å‰} {ä¸Šæ¬¡};
                #var char[HP][$bakName] {$char[HP][$name]};

                #var char[HP][$name] {$value};

                #local maxName {$name};
                #replace maxName {å½“å‰} {æœ€å¤§};

                #if { "$gGMCP[Status][$maxName]" != "" } {
                    #var char[HP][$maxName] {$gGMCP[Status][$maxName]};
                };

                #local pctName {$name};
                #replace pctName {å½“å‰%*} {&1ç™¾åˆ†æ¯”};

                #if { "$name" == "å½“å‰{å†…åŠ›|ç²¾åŠ›}" } {
                    #math char[HP][$pctName] { $char[HP][$name] * 50 / $char[HP][$maxName] };
                };
                #else {
                    #math char[HP][$pctName] { $char[HP][$name] * 100 / $char[HP][$maxName] };
                };

                #if { "$name" == "å½“å‰æ°”è¡€" } {
                    #math char[HP][æ°”è¡€å¥åº·åº¦] { $gGMCP[Status][æœ‰æ•ˆæ°”è¡€] * 100 / $char[HP][æœ€å¤§æ°”è¡€] };
                };
                #elseif { "$name" == "å½“å‰ç²¾ç¥" } {
                    #math char[HP][ç²¾ç¥å¥åº·åº¦] { $gGMCP[Status][æœ‰æ•ˆç²¾ç¥] * 100 / $char[HP][æœ€å¤§ç²¾ç¥] };
                };

                #continue;
            };
            #else {
                #if { "$name" == "å¿™" } {
                    #local busy {$value};
                };
                #elseif { "$name" == "æˆ˜æ–—ä¸­" } {
                    #local fight {$value};
                };
                #var char[HP][$name] {$value};
                #continue;
            };
        };

        #local name {$gmcp-name-map[æ¡£æ¡ˆ][$key]};
        #if { "$name" != "" } {
            #local hasScore {1};
            #if { "$name" == "{å¤´è¡”|å¤§å}" } {
                #var char[æ¡£æ¡ˆ][å½©è‰²$name] {$value};
                #replace value {%+1..c} {};
                #var char[æ¡£æ¡ˆ][$name] {$value};
            };
            #else {
                #var char[æ¡£æ¡ˆ][$name] {$value};
            };
            #continue;
        };

        #local name {$gmcp-name-map[å¤©èµ‹][$key]};
        #if { "$name" != "" } {
            #local hasScore {1};
            #var char[æ¡£æ¡ˆ][å¤©èµ‹][$name] {$value};
            #continue;
        };

        warnLog æœªèƒ½è¯†åˆ«çš„ GMCP çŠ¶æ€ä¿¡æ¯ $key => $value;
    };

    #if     { $hasHP } {
        event.Emit char/hpbrief;
        #delay {gmcp.HPSummarize} {char.HPSummarize} {0};
    };

    #if     { $hasScore }           {event.Emit char/score};

    #if     { "$busy" == "true" }   {event.Emit char/busy};
    #elseif { "$busy" == "false" }  {event.Emit char/nobusy};

    #if     { "$fight" == "true" }  {event.Emit char/fight};
    #elseif { "$fight" == "false" } {event.Emit char/nofight};
};

#action {^GMCP é¢‘é“æ”¶å¬æ±‡æ€»ï¼š$E} {
    #class gmcp-channel-status open;

    #action {^%*(%*) %s {ğŸ””|ğŸ”•}$} {
        #local channel {%%2};
        #local status  {true};
        #if { "%%4" == "ğŸ”•" } {
            #local status  {false};
        };
        #var {gGMCP[Channels][$channel]} {$status};
    };

    #action {^ä½ æ¥æ”¶GMCPä¿¡æ¯çš„æ ¼å¼ä¸º%*ï¼Œä½ å¯ä»¥ç”¨tune gmcp <channel> on/offå¼€å…³GMCPé¢‘é“ã€‚$} {
        #class gmcp-channel-status kill;
    };

    #class gmcp-channel-status close;
};

#action {^ä½ æ‰“å¼€äº†GMCP:%*é¢‘é“ã€‚$}           {#var gGMCP[Channels][%1] {true}};
#action {^ä½ å…³é—­äº†GMCP:%*é¢‘é“ã€‚$}           {#var gGMCP[Channels][%1] {false}};
#action {^ä½ çš„GMCP:%*é¢‘é“å·²ç»æ˜¯æ‰“å¼€çš„ã€‚$}   {#var gGMCP[Channels][%1] {true}};
#action {^ä½ çš„GMCP:%*é¢‘é“å·²ç»æ˜¯å…³é—­çš„ã€‚$}   {#var gGMCP[Channels][%1] {false}};
