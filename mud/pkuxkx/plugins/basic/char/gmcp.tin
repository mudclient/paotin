#nop vim: set filetype=tt:;

/*
æœ¬æ–‡ä»¶å±äº PaoTin++ çš„ä¸€éƒ¨åˆ†
===========
PaoTin++ Â© 2020~2023 çš„æ‰€æœ‰ç‰ˆæƒå‡ç”±æ‹…å­ç‚®(dzp <danzipao@gmail.com>) äº«æœ‰å¹¶ä¿ç•™ä¸€åˆ‡æ³•å¾‹æƒåˆ©
ä½ å¯ä»¥åœ¨éµç…§ GPLv3 åè®®çš„åŸºç¡€ä¹‹ä¸Šä½¿ç”¨ã€ä¿®æ”¹åŠé‡æ–°åˆ†å‘æœ¬ç¨‹åºã€‚
===========
*/

#var basic_char_gmcp[META] {
    {NAME}      {GMCPè§’è‰²ä¿¡æ¯}
    {DESC}      {è§£æ GMCP.Status äº‹ä»¶æä¾›çš„è§’è‰²ä¿¡æ¯}
    {AUTHOR}    {æ‹…å­ç‚®}
    {NOTE}      {æœ¬æ–‡ä»¶å±äº PaoTin++ çš„ä¸€éƒ¨åˆ†}
};

load-lib event;
load-lib speedo;

event.Define {char/busy}    {æ— å‚} {$MODULE} {è§’è‰²è¢« busy äº†};
event.Define {char/nobusy}  {æ— å‚} {$MODULE} {è§’è‰²è§£é™¤ busy äº†};
event.Define {char/fight}   {æ— å‚} {$MODULE} {è§’è‰²æˆ˜æ–—å¼€å§‹};
event.Define {char/nofight} {æ— å‚} {$MODULE} {è§’è‰²è„±ç¦»æˆ˜æ–—};

#func {basic_char_gmcp.Init} {
    event.Handle {GMCP.Status} {char/gmcp} {basic/char/gmcp} {char.gmcp.status};
};

#var {gmcp-name-map} {
    {HPä¸»è¦} {
        {æœ€å¤§å†…åŠ›}      {æœ€å¤§å†…åŠ›}      {max_neili}         {æœ€å¤§å†…åŠ›}
        {å†…åŠ›}          {å½“å‰å†…åŠ›}      {neili}             {å½“å‰å†…åŠ›}
        {æœ€å¤§ç²¾åŠ›}      {æœ€å¤§ç²¾åŠ›}      {max_jingli}        {æœ€å¤§ç²¾åŠ›}
        {ç²¾åŠ›}          {å½“å‰ç²¾åŠ›}      {jingli}            {å½“å‰ç²¾åŠ›}
        {æœ€å¤§æ°”è¡€}      {æœ€å¤§æ°”è¡€}      {max_qi}            {æœ€å¤§æ°”è¡€}
        {æœ‰æ•ˆæ°”è¡€}      {æœ‰æ•ˆæ°”è¡€}      {eff_qi}            {æœ‰æ•ˆæ°”è¡€}
        {æ°”è¡€}          {å½“å‰æ°”è¡€}      {qi}                {å½“å‰æ°”è¡€}
        {æœ€å¤§ç²¾ç¥}      {æœ€å¤§ç²¾ç¥}      {max_jing}          {æœ€å¤§ç²¾ç¥}
        {æœ‰æ•ˆç²¾ç¥}      {æœ‰æ•ˆç²¾ç¥}      {eff_jing}          {æœ‰æ•ˆç²¾ç¥}
        {ç²¾ç¥}          {å½“å‰ç²¾ç¥}      {jing}              {å½“å‰ç²¾ç¥}
        {çœŸæ°”}          {å½“å‰çœŸæ°”}      {vigour/qi}         {å½“å‰çœŸæ°”}
        {å¿™}            {å¿™}            {is_busy}           {å¿™}
        {æˆ˜æ–—ä¸­}        {æˆ˜æ–—ä¸­}        {is_fighting}       {æˆ˜æ–—ä¸­}
    }

    {HPæ¬¡è¦} {
        {ç»éªŒ}          {ç»éªŒ}          {combat_exp}        {ç»éªŒ}
        {æ½œèƒ½}          {æ½œèƒ½}          {potential}         {æ½œèƒ½}
        {çœŸå…ƒ}          {çœŸå…ƒ}          {vigour/yuan}       {çœŸå…ƒ}
        {é£Ÿç‰©}          {é£Ÿç‰©}          {food}              {é£Ÿç‰©}
        {é¥®æ°´}          {é¥®æ°´}          {water}             {é¥®æ°´}
        {æˆ˜æ„}          {æˆ˜æ„}          {fighter_spirit}    {æˆ˜æ„}
    }

    {æ¡£æ¡ˆ} {
        {å¤´è¡”}      {å¤´è¡”}              {title}                 {å¤´è¡”}
        {é—¨æ´¾}      {é—¨æ´¾}              {family/family_name}    {é—¨æ´¾}
        {çº§åˆ«}      {äººç‰©ç­‰çº§}          {level}                 {äººç‰©ç­‰çº§}
        {ï¼©ï¼¤}      {è´¦å·}              {id}                    {è´¦å·}
        {å§“å}      {å¤§å}              {name}                  {å¤§å}
    }

    {å¤©èµ‹} {
        {å®¹è²Œ}      {å®¹è²Œ}              {per}                   {å®¹è²Œ}
        {è†‚åŠ›}      {è†‚åŠ›}              {str}                   {è†‚åŠ›}
        {æ‚Ÿæ€§}      {æ‚Ÿæ€§}              {int}                   {æ‚Ÿæ€§}
        {æ ¹éª¨}      {æ ¹éª¨}              {con}                   {æ ¹éª¨}
        {èº«æ³•}      {èº«æ³•}              {dex}                   {èº«æ³•}
    }
};

#alias {char.gmcp.status} {
    #local hasHP1   {0};
    #local hasHP2   {0};
    #local hasScore {0};

    #local id {$gGMCP[Status][id]};
    #if { "$id" == "" } {
        #local id {$gGMCP[Status][ï¼©ï¼¤]};
    };

    #nop ID ä¸­åŒ…å« # å·çš„ï¼Œæ˜¯ NPCï¼Œæ²¡æœ‰ # å·ä½†å’Œè‡ªå·± ID ä¸åŒçš„ï¼Œæ˜¯ç©å®¶ã€‚;
    #nop æ²¡æœ‰ ID æˆ–è€… ID å’Œè‡ªå·±ç›¸åŒçš„ï¼Œæ‰æ˜¯è‡ªå·±çš„æ•°æ®ã€‚;
    #if { "$id" != "" && "$id" != "$user[id]" } {
        #return;
    };

    #local needUpdate   {};
    #local key          {};
    #foreach {*gGMCP[Status][]} {key} {
        #local value {$gGMCP[Status][$key]};

        #local name {$gmcp-name-map[HPä¸»è¦][$key]};
        #if { "$name" != "" } {
            #if { $char[HP][$name] == $value } {
                #nop æœåŠ¡å™¨æœ‰æ—¶å€™æ¨é€è¿‡æ¥çš„æ•°æ®æ²¡æœ‰å˜åŒ–ï¼Œè¿™æ—¶å€™å°±å¿½ç•¥ï¼Œå½“å®ƒä¸å­˜åœ¨ã€‚;
                #continue;
            };

            #local hasHP1 {1};

            #if { "$name" == "å½“å‰%*" } {
                speedo.Set {$name} {$value} {true} {10};
                #local bakName {@str.Replace{$name;å½“å‰;ä¸Šæ¬¡}};
                #local pctName {@str.Replace{$name;å½“å‰%*;&1ç™¾åˆ†æ¯”}};
                #var char[HP][$bakName] {0};
                #var char[HP][$bakName] {$char[HP][$name]};
                #local needUpdate[$pctName] {true};
            };
            #elseif { "$name" == "æœ‰æ•ˆ{æ°”è¡€|ç²¾ç¥}" } {
                #local health  {@str.Replace{$name;æœ‰æ•ˆ%*;&1å¥åº·åº¦}};
                #local needUpdate[$health] {true};
            };
            #elseif { "$name" == "æœ€å¤§{æ°”è¡€|ç²¾ç¥|å†…åŠ›|ç²¾åŠ›}" } {
                #local pctName {@str.Replace{$name;æœ€å¤§%*;&1ç™¾åˆ†æ¯”}};
                #local needUpdate[$pctName] {true};
                #if { "$name" == "æœ€å¤§{æ°”è¡€|ç²¾ç¥}" } {
                    #local health  {@str.Replace{$name;æœ€å¤§%*;&1å¥åº·åº¦}};
                    #local needUpdate[$health]  {true};
                };
            };
            #else {
                #if { "$name" == "{å¿™|æˆ˜æ–—ä¸­}" } {
                    char.set-flag $name $value false;
                };
            };

            #var char[HP][$name] {$value};
            #continue;
        };

        #local name {$gmcp-name-map[HPæ¬¡è¦][$key]};
        #if { "$name" != "" } {
            #local hasHP2 {1};
            #var char[HP][$name] {$value};
            #if { "$name" == "{ç»éªŒ|æ½œèƒ½}" } {
                speedo.Set {$name} {$value} {true} {600};
            };
            #elseif { "$name" == "{é£Ÿç‰©|é¥®æ°´}" } {
                speedo.Set {$name} {$value} {true} {10};
            };
            #continue;
        };

        #local name {$gmcp-name-map[æ¡£æ¡ˆ][$key]};
        #if { "$name" != "" } {
            #local hasScore {1};
            #if { "$name" == "{å¤´è¡”|å¤§å}" } {
                #var char[æ¡£æ¡ˆ][å½©è‰²$name] {$value};
                #replace value {%+1..c} {};
                #var char[æ¡£æ¡ˆ][$name] {$value};
            };
            #else {
                #var char[æ¡£æ¡ˆ][$name] {$value};
            };
            #continue;
        };

        #local name {$gmcp-name-map[å¤©èµ‹][$key]};
        #if { "$name" != "" } {
            #local hasScore {1};
            #var char[æ¡£æ¡ˆ][å¤©èµ‹][$name] {$value};
            #continue;
        };

        warnLog æœªèƒ½è¯†åˆ«çš„ GMCP çŠ¶æ€ä¿¡æ¯ $key => $value;
    };

    #if { $hasHP1 + $hasHP2 > 0 } {
        #foreach {*needUpdate[]} {key} {
            #if { "$key" == "%*ç™¾åˆ†æ¯”" } {
                #local current {@str.Replace{$key;%*ç™¾åˆ†æ¯”;å½“å‰&1}};
                #local maxName {@str.Replace{$key;%*ç™¾åˆ†æ¯”;æœ€å¤§&1}};
                #local scale   {@if{"$key" == "{å†…åŠ›|ç²¾åŠ›}ç™¾åˆ†æ¯”";2;1}};
                #math char[HP][$key] { $char[HP][$current] * 100 / $char[HP][$maxName] / $scale };
            };
            #elseif { "$key" == "%*å¥åº·åº¦" } {
                #local effName {@str.Replace{$key;%*å¥åº·åº¦;æœ‰æ•ˆ&1}};
                #local maxName {@str.Replace{$key;%*å¥åº·åº¦;æœ€å¤§&1}};
                #math char[HP][$key] { $char[HP][$effName] * 100 / $char[HP][$maxName] };
            };
        };

        #if { $hasHP1 } {
            char.HPSummarize è‡ªåŠ¨;
        };
        #else {
            char.HPSummarize æ€»æ˜¯;
        };

        event.Emit char/hpbrief;
    };

    #if { $hasScore } {event.Emit char/score};
};

#action {^GMCP é¢‘é“æ”¶å¬æ±‡æ€»ï¼š$E} {
    #class gmcp-channel-status open;

    #action {^%*(%*) %s {ğŸ””|ğŸ”•}$} {
        #local channel {%%2};
        #local status  {true};
        #if { "%%4" == "ğŸ”•" } {
            #local status  {false};
        };
        #var {gGMCP[Channels][$channel]} {$status};
    };

    #action {^ä½ æ¥æ”¶GMCPä¿¡æ¯çš„æ ¼å¼ä¸º%*ï¼Œä½ å¯ä»¥ç”¨tune gmcp <channel> on/offå¼€å…³GMCPé¢‘é“ã€‚$} {
        #class gmcp-channel-status kill;
    };

    #class gmcp-channel-status close;
};

#action {^ä½ æ‰“å¼€äº†GMCP:%*é¢‘é“ã€‚$}           {#var gGMCP[Channels][%1] {true}};
#action {^ä½ å…³é—­äº†GMCP:%*é¢‘é“ã€‚$}           {#var gGMCP[Channels][%1] {false}};
#action {^ä½ çš„GMCP:%*é¢‘é“å·²ç»æ˜¯æ‰“å¼€çš„ã€‚$}   {#var gGMCP[Channels][%1] {true}};
#action {^ä½ çš„GMCP:%*é¢‘é“å·²ç»æ˜¯å…³é—­çš„ã€‚$}   {#var gGMCP[Channels][%1] {false}};
